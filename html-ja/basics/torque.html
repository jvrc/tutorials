

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>RTコンポーネントにおけるトルク指令の入力 &mdash; jvrc tutorials 0.0.1 ドキュメント</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="jvrc tutorials 0.0.1 ドキュメント" href="../index.html"/>
        <link rel="up" title="シミュレーションの基本" href="index.html"/>
        <link rel="next" title="シミュレーションの応用" href="../advanced/index.html"/>
        <link rel="prev" title="RTコンポーネントのコントローラの接続" href="rt-controller.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> jvrc tutorials
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">インストール</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index.html">Choreonoidの解説</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">シミュレーションの基本</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="howto-exec-simulation.html">シミュレーションの実行</a></li>
<li class="toctree-l2"><a class="reference internal" href="rt-controller.html">RTコンポーネントのコントローラの接続</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">RTコンポーネントにおけるトルク指令の入力</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rt">RTコンポーネントの拡張</a></li>
<li class="toctree-l3"><a class="reference internal" href="#source-code-of-a-controller">コントローラのソースコード</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-the-controller">コントローラのビルド</a></li>
<li class="toctree-l3"><a class="reference internal" href="#choreonoid">Choreonoidの起動</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-pose-sequence-item">ポーズ列の追加</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-of-the-controller">コントローラの設定</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-simulation">シミュレーションを実行する</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">サンプルファイルについて</a><ul class="simple">
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/index.html">シミュレーションの応用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../links.html">リンク</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">jvrc tutorials</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">シミュレーションの基本</a> &raquo;</li>
      
    <li>RTコンポーネントにおけるトルク指令の入力</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/basics/torque.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="joint-control-using-a-rt-component">
<h1>RTコンポーネントにおけるトルク指令の入力<a class="headerlink" href="#joint-control-using-a-rt-component" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>ここでは、Choreonoidを用いて、ロボットの動作パターンを作成する方法、そのパターンをロボットで実行できるように前節で作成したRTコンポーネントを拡張する方法について解説します。</p>
<div class="section" id="rt">
<h2>RTコンポーネントの拡張<a class="headerlink" href="#rt" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>関節のPD制御を行うために、前の節で作成したRTコンポーネントRobotControllerRTCを拡張します。PD制御を行うためには、関節へのトルク指令を出力する必要があるため、トルク指令用のデータポートをRTCBuilderを用いて追加します。追加するデータポートのプロファイルは次のようになります。</p>
<ul>
<li><p class="first">OutPort プロファイル:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="74%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>ポート名:</td>
<td>u</td>
</tr>
<tr class="row-even"><td>データ型:</td>
<td>RTC::TimeDoubleSeq</td>
</tr>
<tr class="row-odd"><td>変数名:</td>
<td>torque</td>
</tr>
<tr class="row-even"><td>表示位置:</td>
<td>RIGHT</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>データポートを追加し、再度コード生成を行ったら、ビルドができることを確認しておきます。</p>
</div>
<div class="section" id="source-code-of-a-controller">
<h2>コントローラのソースコード<a class="headerlink" href="#source-code-of-a-controller" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>コントローラのヘッダファイルはいかのようになります。</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*!</span>
<span class="cm"> * @file  RobotControllerRTC.h</span>
<span class="cm"> * @brief Robot Controller component</span>
<span class="cm"> * @date  $Date$</span>
<span class="cm"> *</span>
<span class="cm"> * $Id$</span>
<span class="cm"> */</span>

<span class="cp">#ifndef ROBOTCONTROLLERRTC_H</span>
<span class="cp">#define ROBOTCONTROLLERRTC_H</span>

<span class="cp">#include &lt;rtm/idl/BasicDataTypeSkel.h&gt;</span>
<span class="cp">#include &lt;rtm/idl/ExtendedDataTypesSkel.h&gt;</span>
<span class="cp">#include &lt;rtm/idl/InterfaceDataTypesSkel.h&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">RTC</span><span class="p">;</span>

<span class="cp">#include &lt;rtm/Manager.h&gt;</span>
<span class="cp">#include &lt;rtm/DataFlowComponentBase.h&gt;</span>
<span class="cp">#include &lt;rtm/CorbaPort.h&gt;</span>
<span class="cp">#include &lt;rtm/DataInPort.h&gt;</span>
<span class="cp">#include &lt;rtm/DataOutPort.h&gt;</span>

<span class="k">class</span> <span class="nc">RobotControllerRTC</span>
  <span class="o">:</span> <span class="k">public</span> <span class="n">RTC</span><span class="o">::</span><span class="n">DataFlowComponentBase</span>
<span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">RobotControllerRTC</span><span class="p">(</span><span class="n">RTC</span><span class="o">::</span><span class="n">Manager</span><span class="o">*</span> <span class="n">manager</span><span class="p">);</span>
    <span class="o">~</span><span class="n">RobotControllerRTC</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="n">RTC</span><span class="o">::</span><span class="n">ReturnCode_t</span> <span class="n">onInitialize</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="n">RTC</span><span class="o">::</span><span class="n">ReturnCode_t</span> <span class="n">onActivated</span><span class="p">(</span><span class="n">RTC</span><span class="o">::</span><span class="n">UniqueId</span> <span class="n">ec_id</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="n">RTC</span><span class="o">::</span><span class="n">ReturnCode_t</span> <span class="n">onDeactivated</span><span class="p">(</span><span class="n">RTC</span><span class="o">::</span><span class="n">UniqueId</span> <span class="n">ec_id</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="n">RTC</span><span class="o">::</span><span class="n">ReturnCode_t</span> <span class="n">onExecute</span><span class="p">(</span><span class="n">RTC</span><span class="o">::</span><span class="n">UniqueId</span> <span class="n">ec_id</span><span class="p">);</span>

 <span class="k">protected</span><span class="o">:</span>
   <span class="n">RTC</span><span class="o">::</span><span class="n">TimedDoubleSeq</span> <span class="n">m_angle</span><span class="p">;</span>
   <span class="n">InPort</span><span class="o">&lt;</span><span class="n">RTC</span><span class="o">::</span><span class="n">TimedDoubleSeq</span><span class="o">&gt;</span> <span class="n">m_angleIn</span><span class="p">;</span>

   <span class="n">RTC</span><span class="o">::</span><span class="n">TimedCharSeq</span> <span class="n">m_torque</span><span class="p">;</span>
   <span class="n">OutPort</span><span class="o">&lt;</span><span class="n">RTC</span><span class="o">::</span><span class="n">TimedCharSeq</span><span class="o">&gt;</span> <span class="n">m_torqueOut</span><span class="p">;</span>
 <span class="k">private</span><span class="o">:</span>

<span class="p">};</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span>
<span class="p">{</span>
  <span class="n">DLL_EXPORT</span> <span class="kt">void</span> <span class="n">RobotControllerRTCInit</span><span class="p">(</span><span class="n">RTC</span><span class="o">::</span><span class="n">Manager</span><span class="o">*</span> <span class="n">manager</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="c1">// ROBOTCONTROLLERRTC_H</span>
</pre></div>
</td></tr></table></div>
<p>今回はトルクの出力をしなければならないので、出力ポートのための設定が増加しています。 <cite>RTC::OutPort&lt;RTC::TimedDoubleSeq&gt;</cite> はRTCの出力ポートを表す型であり、出力ポートを操作するにはこれを利用します。</p>
<p>コントローラのソースコードは以下になります。</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*!</span>
<span class="cm"> * @file  RobotControllerRTC.cpp</span>
<span class="cm"> * @brief Robot Controller component</span>
<span class="cm"> * @date $Date$</span>
<span class="cm"> *</span>
<span class="cm"> * $Id$</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;RobotControllerRTC.h&quot;</span>
<span class="cp">#include &lt;cnoid/BodyMotion&gt;</span>
<span class="cp">#include &lt;cnoid/ExecutablePath&gt;</span>
<span class="cp">#include &lt;cnoid/FileUtil&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">cnoid</span><span class="p">;</span>

<span class="k">namespace</span> <span class="p">{</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">double</span> <span class="n">pgain</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mf">50000.0</span><span class="p">,</span> <span class="mf">30000.0</span><span class="p">,</span> <span class="mf">30000.0</span><span class="p">,</span> <span class="mf">30000.0</span><span class="p">,</span> <span class="mf">30000.0</span><span class="p">,</span>
    <span class="mf">80000.0</span><span class="p">,</span> <span class="mf">80000.0</span><span class="p">,</span> <span class="mf">10000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">30000.0</span><span class="p">,</span>
    <span class="mf">30000.0</span><span class="p">,</span> <span class="mf">80000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">30000.0</span><span class="p">,</span> <span class="mf">10000.0</span><span class="p">,</span>
    <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">30000.0</span><span class="p">,</span> <span class="mf">30000.0</span><span class="p">,</span> <span class="mf">10000.0</span><span class="p">,</span>
    <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">30000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span>
    <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span>
    <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">10000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span>
    <span class="mf">30000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span>
    <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span> <span class="mf">3000.0</span><span class="p">,</span>
    <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">double</span> <span class="n">dgain</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="p">};</span>

<span class="c1">// Module specification</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">robotcontrollerrtc_spec</span><span class="p">[]</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="s">&quot;implementation_id&quot;</span><span class="p">,</span> <span class="s">&quot;RobotControllerRTC&quot;</span><span class="p">,</span>
    <span class="s">&quot;type_name&quot;</span><span class="p">,</span>         <span class="s">&quot;RobotControllerRTC&quot;</span><span class="p">,</span>
    <span class="s">&quot;description&quot;</span><span class="p">,</span>       <span class="s">&quot;Robot Controller component&quot;</span><span class="p">,</span>
    <span class="s">&quot;version&quot;</span><span class="p">,</span>           <span class="s">&quot;1.0.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;vendor&quot;</span><span class="p">,</span>            <span class="s">&quot;AIST&quot;</span><span class="p">,</span>
    <span class="s">&quot;category&quot;</span><span class="p">,</span>          <span class="s">&quot;Generic&quot;</span><span class="p">,</span>
    <span class="s">&quot;activity_type&quot;</span><span class="p">,</span>     <span class="s">&quot;PERIODIC&quot;</span><span class="p">,</span>
    <span class="s">&quot;kind&quot;</span><span class="p">,</span>              <span class="s">&quot;DataFlowComponent&quot;</span><span class="p">,</span>
    <span class="s">&quot;max_instance&quot;</span><span class="p">,</span>      <span class="s">&quot;1&quot;</span><span class="p">,</span>
    <span class="s">&quot;language&quot;</span><span class="p">,</span>          <span class="s">&quot;C++&quot;</span><span class="p">,</span>
    <span class="s">&quot;lang_type&quot;</span><span class="p">,</span>         <span class="s">&quot;compile&quot;</span><span class="p">,</span>
    <span class="s">&quot;&quot;</span>
  <span class="p">};</span>

<span class="n">RobotControllerRTC</span><span class="o">::</span><span class="n">RobotControllerRTC</span><span class="p">(</span><span class="n">RTC</span><span class="o">::</span><span class="n">Manager</span><span class="o">*</span> <span class="n">manager</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">RTC</span><span class="o">::</span><span class="n">DataFlowComponentBase</span><span class="p">(</span><span class="n">manager</span><span class="p">),</span>
    <span class="n">m_angleIn</span><span class="p">(</span><span class="s">&quot;q&quot;</span><span class="p">,</span> <span class="n">m_angle</span><span class="p">),</span>
    <span class="n">m_torqueOut</span><span class="p">(</span><span class="s">&quot;u&quot;</span><span class="p">,</span> <span class="n">m_torque</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">RobotControllerRTC</span><span class="o">::~</span><span class="n">RobotControllerRTC</span><span class="p">()</span>
<span class="p">{</span>

<span class="p">}</span>


<span class="n">RTC</span><span class="o">::</span><span class="n">ReturnCode_t</span> <span class="n">RobotControllerRTC</span><span class="o">::</span><span class="n">onInitialize</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">addInPort</span><span class="p">(</span><span class="s">&quot;q&quot;</span><span class="p">,</span> <span class="n">m_angleIn</span><span class="p">);</span>
  <span class="n">addOutPort</span><span class="p">(</span><span class="s">&quot;u&quot;</span><span class="p">,</span> <span class="n">m_torqueOut</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">RTC</span><span class="o">::</span><span class="n">RTC_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">RTC</span><span class="o">::</span><span class="n">ReturnCode_t</span> <span class="n">RobotControllerRTC</span><span class="o">::</span><span class="n">onActivated</span><span class="p">(</span><span class="n">RTC</span><span class="o">::</span><span class="n">UniqueId</span> <span class="n">ec_id</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">qseq</span><span class="p">){</span>
    <span class="n">string</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">getNativePathString</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">filesystem</span><span class="o">::</span><span class="n">path</span><span class="p">(</span><span class="n">shareDirectory</span><span class="p">())</span>
      <span class="o">/</span> <span class="s">&quot;motion&quot;</span> <span class="o">/</span> <span class="s">&quot;RobotPattern.yaml&quot;</span><span class="p">);</span>

    <span class="n">BodyMotion</span> <span class="n">motion</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">motion</span><span class="p">.</span><span class="n">loadStandardYAMLformat</span><span class="p">(</span><span class="n">filename</span><span class="p">)){</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">motion</span><span class="p">.</span><span class="n">seqMessage</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">RTC</span><span class="o">::</span><span class="n">RTC_ERROR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">qseq</span> <span class="o">=</span> <span class="n">motion</span><span class="p">.</span><span class="n">jointPosSeq</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">qseq</span><span class="o">-&gt;</span><span class="n">numFrames</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Empty motion data.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">RTC</span><span class="o">::</span><span class="n">RTC_ERROR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">q0</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">qseq</span><span class="o">-&gt;</span><span class="n">numParts</span><span class="p">());</span>
    <span class="n">timeStep_</span> <span class="o">=</span> <span class="n">qseq</span><span class="o">-&gt;</span><span class="n">getTimeStep</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">m_torque</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">(</span><span class="n">qseq</span><span class="o">-&gt;</span><span class="n">numParts</span><span class="p">());</span>

  <span class="k">if</span><span class="p">(</span><span class="n">m_angleIn</span><span class="p">.</span><span class="n">isNew</span><span class="p">()){</span>
    <span class="n">m_angleIn</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qseq</span><span class="o">-&gt;</span><span class="n">numParts</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="n">q0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_angle</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">oldFrame</span> <span class="o">=</span> <span class="n">qseq</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">currentFrame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">RTC</span><span class="o">::</span><span class="n">RTC_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">RTC</span><span class="o">::</span><span class="n">ReturnCode_t</span> <span class="n">RobotControllerRTC</span><span class="o">::</span><span class="n">onDeactivated</span><span class="p">(</span><span class="n">RTC</span><span class="o">::</span><span class="n">UniqueId</span> <span class="n">ec_id</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">RTC</span><span class="o">::</span><span class="n">RTC_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">RTC</span><span class="o">::</span><span class="n">ReturnCode_t</span> <span class="n">RobotControllerRTC</span><span class="o">::</span><span class="n">onExecute</span><span class="p">(</span><span class="n">RTC</span><span class="o">::</span><span class="n">UniqueId</span> <span class="n">ec_id</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">m_angleIn</span><span class="p">.</span><span class="n">isNew</span><span class="p">()){</span>
    <span class="n">m_angleIn</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="n">currentFrame</span> <span class="o">&gt;</span> <span class="n">qseq</span><span class="o">-&gt;</span><span class="n">numFrames</span><span class="p">()){</span>
    <span class="n">m_torqueOut</span><span class="p">.</span><span class="n">write</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">RTC</span><span class="o">::</span><span class="n">RTC_OK</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">MultiValueSeq</span><span class="o">::</span><span class="n">Frame</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">qseq</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">(</span><span class="n">currentFrame</span><span class="o">++</span><span class="p">);</span>

  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="kt">double</span> <span class="n">q_ref</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">double</span> <span class="n">q</span> <span class="o">=</span> <span class="n">m_angle</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">double</span> <span class="n">dq_ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_ref</span> <span class="o">-</span> <span class="n">oldFrame</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">timeStep_</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">dq</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">q0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">timeStep_</span><span class="p">;</span>
    <span class="n">m_torque</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_ref</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">pgain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">100.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">dq_ref</span> <span class="o">-</span> <span class="n">dq</span><span class="p">)</span> <span class="o">*</span> <span class="n">dgain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">100.0</span><span class="p">;</span>
    <span class="n">q0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;i = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;q_ref = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;q = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">q</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dq_ref = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dq_ref</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;dq = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dq</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;torque = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_torque</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">oldFrame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>

  <span class="n">m_torqueOut</span><span class="p">.</span><span class="n">write</span><span class="p">();</span>

  <span class="k">return</span> <span class="n">RTC</span><span class="o">::</span><span class="n">RTC_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">extern</span> <span class="s">&quot;C&quot;</span>
<span class="p">{</span>
  <span class="n">DLL_EXPORT</span> <span class="kt">void</span> <span class="n">RobotControllerRTCInit</span><span class="p">(</span><span class="n">RTC</span><span class="o">::</span><span class="n">Manager</span><span class="o">*</span> <span class="n">manager</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">coil</span><span class="o">::</span><span class="n">Properties</span> <span class="n">profile</span><span class="p">(</span><span class="n">robotcontrollerrtc_spec</span><span class="p">);</span>
    <span class="n">manager</span><span class="o">-&gt;</span><span class="n">registerFactory</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span>
                             <span class="n">RTC</span><span class="o">::</span><span class="n">Create</span><span class="o">&lt;</span><span class="n">RobotControllerRTC</span><span class="o">&gt;</span><span class="p">,</span>
                             <span class="n">RTC</span><span class="o">::</span><span class="n">Delete</span><span class="o">&lt;</span><span class="n">RobotControllerRTC</span><span class="o">&gt;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</td></tr></table></div>
<p>出力ポートに関する設定は、入力ポートの場合と関数名が異なるだけでよく似ています。</p>
<p>onActivated() のときの処理に注目しましょう。この関数はRTCが有効化された際に一度だけ呼ばれます。 ここで、Choreonoidの共有ディレクトリからRobotPattern.yamlを読み出しています。 これはロボットの全関節角度の軌道を記述した動作パターンファイルです。 <cite>motion.loadStandardYAMLformat()</cite> によりモーションデータに変換します。 onActivated()では初期値の設定も行っています。</p>
<p>onExecute()ではトルクの計算と出力の処理が追加されました。 関節角度を読み込む部分のコードはこれまでと同じですが、 <cite>m_torque.data[i]</cite> に計算したトルクの値を代入しています。 ここでは簡単なPD制御によりトルクの値を求めています。 各関節毎のPgainとDgainはソースコードの先頭付近に固定値で定義されています。 ロボットがうまく制御できない場合はこの値を調整する必要があります。 <cite>m_torque.data</cite> にセットした値は <cite>m_torqueOut.write()</cite> により実際のロボットの制御トルクとして出力されます。 出力ポートは値をセットするだけなので入力ポートよりも簡単です。</p>
</div>
<div class="section" id="build-the-controller">
<h2>コントローラのビルド<a class="headerlink" href="#build-the-controller" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>コントローラの実装ができたので、再度makeをし、前節と同じ場所にRTCをインストールします。</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>make
<span class="nv">$ </span>sudo cp -p src/RobotControllerRTC.so /usr/lib/choreonoid-1.5/rtc
</pre></div>
</div>
</div>
<div class="section" id="choreonoid">
<h2>Choreonoidの起動<a class="headerlink" href="#choreonoid" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>前節で作成したプロジェクトファイル、sample2.cnoidを開きます。</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>choreonoid sample2.cnoid
</pre></div>
</div>
</div>
<div class="section" id="create-a-pose-sequence-item">
<h2>ポーズ列の追加<a class="headerlink" href="#create-a-pose-sequence-item" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>まずアイテムビューで「JVRC」を選択します。 次に、「メニュー」の「ファイル」「新規」より「ポーズ列」を選択し「SampleMotion」という名前で追加します。</p>
<img alt="../_images/motion.png" src="../_images/motion.png" />
<p>次に、[表示]-[ビューの表示]-[ポーズロール]を選択します。次の画面が表示されるはずです。</p>
<img alt="../_images/pose_role.png" src="../_images/pose_role.png" />
<p>基準の姿勢を作るため、アイテムビューで「JVRC」を選択し、ツールバーにある「選択ボディを初期姿勢に」のボタンを押します。</p>
<img alt="../_images/pose_toolbar.png" src="../_images/pose_toolbar.png" />
<p>ポーズロールにおいて、1.0 を選択して「挿入」を押します。</p>
<blockquote>
<div><img alt="../_images/poserole_neck_01.png" src="../_images/poserole_neck_01.png" />
</div></blockquote>
<p>今回は首を左右に振る動作パターンを作成します。以下の手順でポーズを作成してください。</p>
<ol class="arabic">
<li><p class="first">ポーズロールにおいて 2.0 を選択し、関節スライダにおいて首関節のヨー軸「NECK_Y」を 70.0 にセットし、ポーズロールの「挿入」を押す。</p>
<img alt="../_images/poserole_neck_02.png" src="../_images/poserole_neck_02.png" />
</li>
<li><p class="first">ポーズロールにおいて 3.0 を選択し、関節スライダにおいて首関節のヨー軸「NECK_Y」を 0.0 にセットし、ポーズロールの「挿入」を押す。</p>
<img alt="../_images/poserole_neck_03.png" src="../_images/poserole_neck_03.png" />
</li>
<li><p class="first">ポーズロールにおいて 4.0 を選択し、関節スライダにおいて首関節のヨー軸「NECK_Y」を -70.0 にセットし、ポーズロールの「挿入」を押す。</p>
<img alt="../_images/poserole_neck_04.png" src="../_images/poserole_neck_04.png" />
</li>
<li><p class="first">ポーズロールにおいて 5.0 を選択し、関節スライダにおいて首関節のヨー軸「NECK_Y」を 0.0 にセットし、ポーズロールの「挿入」を押す。</p>
<img alt="../_images/poserole_neck_05.png" src="../_images/poserole_neck_05.png" />
</li>
<li><p class="first">ポーズロールにおいて 6.0 を選択し、関節スライダにおいて首関節のヨー軸「NECK_R」を -50.0 にセットし、ポーズロールの「挿入」を押す。</p>
<img alt="../_images/poserole_neck_06.png" src="../_images/poserole_neck_06.png" />
</li>
</ol>
<p>ポーズロールで作成したのはキーフレームと呼びます。これより、プログラムで使用するモーションを生成させます。 ツールバーから「ボディモーションの生成」ボタンを押します。</p>
<img alt="../_images/motion_toolbar.png" src="../_images/motion_toolbar.png" />
<p>モーションはツールバーのボタンで手動で生成しなくても、キーフレームの更新時に自動生成することができます。 これを有効にするにはツールバーの「自動更新モード」のボタンをオンにしてください。</p>
<img alt="../_images/motion_toolbar2.png" src="../_images/motion_toolbar2.png" />
<p>SampleMotion の子供に motion があるので、これを選択し名前を付けて保存ボタンを押します。</p>
<img alt="../_images/item_motion.png" src="../_images/item_motion.png" />
<p>ファイル名はRobotPattern.yamlとし、コントローラが参照するChoreonoidの共有ディレクトリ、/usr/share/choreonoid-1.5/motionに置いておきます。</p>
</div>
<div class="section" id="setup-of-the-controller">
<h2>コントローラの設定<a class="headerlink" href="#setup-of-the-controller" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Choreonoidには1体のロボットに複数のコントローラを割り当てる機能があります。今JVRCの子アイテムとしてBodyRTCとSampleMotionの2つがありますが、これら2つのうちどちらをシミュレーション時に使用するかを指定する必要があります。ここではBodyRTCを使いますのでBodyRTCの方にチェックを入れておきます。</p>
<img alt="../_images/choose_bodyrtc.png" src="../_images/choose_bodyrtc.png" />
</div>
<div class="section" id="run-simulation">
<h2>シミュレーションを実行する<a class="headerlink" href="#run-simulation" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>シミュレーションを実行すると今度はロボットが崩れ落ちることなく、先ほど作成した首振りのモーションを実行しているはずです。この時RTSystemEditorでRTCの接続を確認すると、下図のようになっており、フィードバックループができていることが確認できます。</p>
<img alt="../_images/openrtp_sample3.png" src="../_images/openrtp_sample3.png" />
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p>別のシーンビューを生成して、同時にカメラの映像を表示してみましょう。</p>
<p>メインメニュー「表示」の「ビューの生成」から「シーン」を選択します。次のウィンドウが表示されるので OK をクリックします。</p>
<img alt="../_images/make_sceneview.png" src="../_images/make_sceneview.png" />
<p>新しいシーンビュー「シーン2」が生成されます。
「シーン2」タブをクリックして選択し、カメラの選択ボタンでロボットのカメラ「JVRC - rcamera」などに表示を切り替えます。</p>
<img alt="../_images/simulation_torque_2.png" src="../_images/simulation_torque_2.png" />
<p>「シーン2」タブをドラッグして二つのシーンを同時に表示することもできます。</p>
<img alt="../_images/simulation_torque_3.png" class="last" src="../_images/simulation_torque_3.png" />
</div>
</div>
<div class="section" id="id1">
<h2>サンプルファイルについて<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>このチュートリアルで作成されるプロジェクトファイルはcnoid/sample3.cnoidに、コントローラのソースコードはrtc/RobotTorqueControllerRTC.h, rtc/RobotTorqueControllerRTC.cppに収録されています。チュートリアルではRobotControllerRTCを拡張していきますが、サンプルファイルではファイル名が重複してしまうため、本チュートリアルで作成するコントローラはRobotTorqueControllerRTCという名称で収録しています。</p>
<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../advanced/index.html" class="btn btn-neutral float-right" title="シミュレーションの応用" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="rt-controller.html" class="btn btn-neutral" title="RTコンポーネントのコントローラの接続" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, AIST.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>